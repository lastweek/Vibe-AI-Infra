---
import Layout from '../layouts/Layout.astro';
import AutoToc from '../components/AutoToc.astro';
import ProjectsTable from '../components/ProjectsTable';
import { getCollection } from 'astro:content';
import { slugifySegment } from '../utils/slug';

const projectEntries = await getCollection('projects');

const categories = projectEntries.map((entry) => {
  const categorySlug = slugifySegment(entry.data.category);
  return {
    category: entry.data.category,
    categorySlug,
    projects: entry.data.projects.map((project) => ({
      ...project,
      href: `/nano-infra/${categorySlug}/${slugifySegment(project.name)}`,
    })),
  };
});

const categoryOrder = ['Silicon', 'Virt', 'Compiler', 'Framework', 'Agent'];
categories.sort((a, b) => categoryOrder.indexOf(a.category) - categoryOrder.indexOf(b.category));

// Stack layer descriptions
const stackLayers = [
  {
    name: 'Agent',
    description: 'AI agents that reason, plan, and execute tasks using the infrastructure layers below.',
    color: '#dbeafe',
  },
  {
    name: 'Framework',
    description: 'Model frameworks, serving systems, and distributed training for AI workloads.',
    color: '#e0f2fe',
  },
  {
    name: 'Compiler',
    description: 'MLIR-based compilers and code generation for optimal model execution.',
    color: '#f0fdf4',
  },
  {
    name: 'Virt',
    description: 'Virtualization stack from hardware (KVM) through hypervisor (VMM) to containers (Sandbox) for agent isolation.',
    color: '#fef3c7',
  },
  {
    name: 'Silicon',
    description: 'GPU architecture and design principles for understanding hardware acceleration of AI.',
    color: '#fce7f3',
  },
];
---

<Layout title="Vibe Nano | Vibe AI Infra" description="Project tracker for Vibe Nano AI infrastructure work.">
  <main class="nano-shell reveal">
    <aside class="side-rail">
      <AutoToc rootSelector=".main-content" itemSelector="[data-toc]" />

      <div class="toc-card">
        <p class="toc-title">Nano Projects</p>
        <nav class="toc-list">
          {categories.map((category) => (
            <div class="toc-category">
              <a href={`/nano-infra/${category.categorySlug}/`} class="toc-category-label">{category.category}</a>
              {category.projects.map((project) => (
                <a href={project.href}>{project.name}</a>
              ))}
            </div>
          ))}
        </nav>
      </div>
    </aside>

    <div class="main-content">
      <header class="page-header" id="overview" data-toc data-toc-label="Overview">
        <span class="badge">Infrastructure Build Tracker</span>
        <h1>Vibe Nano</h1>
        <p class="subtitle">
          A vertically integrated AI infrastructure stack, from silicon through agents.
        </p>
      </header>

      <section class="stack-visualization" id="stack" data-toc data-toc-label="Stack Layers">
        <div class="section-header">
          <h2>Infrastructure Stack</h2>
          <p class="section-subtitle">Five layers forming a complete AI infrastructure foundation</p>
        </div>
        <div class="stack-layers">
          {stackLayers.map((layer, index) => (
            <div class="stack-layer" style={`background: linear-gradient(135deg, ${layer.color} 0%, white 100%);`}>
              <div class="layer-index">{stackLayers.length - index}</div>
              <div class="layer-content">
                <h3 class="layer-name">{layer.name}</h3>
                <p class="layer-description">{layer.description}</p>
              </div>
            </div>
          ))}
        </div>
        <div class="stack-note">
          <p>
            <strong>Why this stack?</strong> Each layer exposes the next bottleneck for AI workloads.
            By building from silicon up, we understand hardware constraints (memory bandwidth, compute),
            virtualization overheads (isolation, context switching), compiler optimizations (operator fusion,
            memory tiling), framework efficiencies (kernel selection, communication patterns), and ultimately
            agent capabilities (reasoning, tool use).
          </p>
        </div>
      </section>

      <section class="table-section" id="project-table" data-toc>
        <div class="section-header">
          <h2>Project Tracker</h2>
          <p class="section-subtitle">Status and progress across all layers</p>
        </div>
        <ProjectsTable categories={categories} client:load />
      </section>
    </div>
  </main>
</Layout>

<style>
  .nano-shell {
    max-width: 1260px;
    margin: 0 auto;
    padding: 52px 20px 90px;
    display: grid;
    grid-template-columns: 290px minmax(0, 1fr);
    gap: 20px;
  }

  .side-rail {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .toc-card {
    position: sticky;
    top: 82px;
    background: rgba(255, 255, 255, 0.94);
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 14px;
  }

  .toc-card + .toc-card {
    top: 244px;
  }

  .toc-title {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
    margin-bottom: 10px;
    font-weight: 700;
  }

  .toc-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 520px;
    overflow: auto;
  }

  .toc-category {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .toc-category-label {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--ink);
    padding: 0.25rem 0.45rem;
    border-radius: 6px;
    background: #f0f4f8;
    text-decoration: none;
  }

  .toc-category-label:hover {
    background: #e5eef5;
  }

  .toc-list a {
    font-size: 0.82rem;
    color: var(--ink-soft);
    padding: 0.25rem 0.45rem 0.25rem 1rem;
    border-radius: 6px;
    margin-left: 0.25rem;
    text-decoration: none;
    display: block;
  }

  .toc-list a:hover {
    background: #eef4ff;
    color: var(--ink);
  }

  .page-header {
    text-align: center;
    max-width: 820px;
    margin: 0 auto 34px;
  }

  .badge {
    display: inline-block;
    padding: 0.32rem 0.75rem;
    background: #dbeafe;
    color: #1d4ed8;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 16px;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }

  h1 {
    font-family: var(--font-display);
    font-size: clamp(2.4rem, 7vw, 4.2rem);
    font-weight: 700;
    letter-spacing: -0.03em;
    line-height: 1.06;
  }

  .subtitle {
    margin: 14px auto 0;
    max-width: 58ch;
    font-size: 1.07rem;
    color: var(--muted);
  }

  .section-header {
    text-align: center;
    margin: 20px auto 20px;
    max-width: 760px;
  }

  .section-header h2 {
    font-family: var(--font-display);
    letter-spacing: -0.02em;
    font-size: 1.8rem;
  }

  .section-subtitle {
    margin-top: 8px;
    color: var(--muted);
    font-size: 0.94rem;
  }

  .stack-visualization {
    margin-bottom: 40px;
  }

  .stack-layers {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-width: 700px;
    margin: 20px auto 0;
  }

  .stack-layer {
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 16px 20px;
    display: grid;
    grid-template-columns: 28px 1fr;
    gap: 12px;
    align-items: start;
    transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease;
  }

  .stack-layer:hover {
    transform: translateX(4px);
    box-shadow: 0 8px 20px rgba(37, 99, 235, 0.12);
    border-color: var(--accent);
  }

  .layer-index {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: rgba(37, 99, 235, 0.15);
    color: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.8rem;
    flex-shrink: 0;
  }

  .layer-content {
    min-width: 0;
  }

  .layer-name {
    font-family: var(--font-display);
    font-size: 1.1rem;
    font-weight: 700;
    letter-spacing: -0.01em;
    margin: 0 0 4px 0;
  }

  .layer-description {
    color: var(--ink-soft);
    font-size: 0.88rem;
    line-height: 1.6;
    margin: 0;
  }

  .stack-note {
    max-width: 700px;
    margin: 24px auto 0;
    padding: 18px 20px;
    background: linear-gradient(135deg, rgba(219, 234, 254, 0.5), rgba(224, 242, 254, 0.3));
    border: 1px solid #bfdbfe;
    border-radius: 12px;
  }

  .stack-note p {
    color: #1e3a8a;
    font-size: 0.9rem;
    line-height: 1.7;
    margin: 0;
  }

  .stack-note strong {
    color: #1e40af;
  }

  .table-section {
    margin-bottom: 28px;
  }

  /* Simple Table Layout with Category Colors */
  :global(.table-wrapper) {
    background: white;
    border: 1px solid #cbd5e1;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(30, 58, 138, 0.06);
  }

  :global(.projects-table) {
    width: 100%;
    border-collapse: collapse;
  }

  :global(.projects-table thead) {
    background: #f8fafc;
    border-bottom: 2px solid #cbd5e1;
  }

  :global(.projects-table th) {
    padding: 8px 16px;
    text-align: left;
    font-weight: 700;
    font-size: 0.75rem;
    color: #475569;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    vertical-align: middle;
  }

  :global(.projects-table td) {
    padding: 8px 16px;
    vertical-align: middle;
  }

  /* Category-specific row colors */
  :global(.projects-table tbody tr.category-silicon) {
    background: #f8fafc;
  }

  :global(.projects-table tbody tr.category-virt) {
    background: #ecfdf5;
  }

  :global(.projects-table tbody tr.category-compiler) {
    background: #f0f9ff;
  }

  :global(.projects-table tbody tr.category-framework) {
    background: #eef2ff;
  }

  :global(.projects-table tbody tr.category-agent) {
    background: #f5f3ff;
  }

  :global(.projects-table tbody tr) {
    border-bottom: 1px solid #cbd5e1;
    cursor: pointer;
    transition: background-color 150ms ease;
  }

  :global(.projects-table tbody tr:last-child) {
    border-bottom: none;
  }

  :global(.projects-table tbody tr:hover) {
    filter: brightness(0.97);
  }

  :global(.category-cell) {
    width: 15%;
    text-align: center;
    border-right: 1px solid #cbd5e1;
  }

  :global(.category-cell .category-badge) {
    display: inline-block;
    padding: 6px 12px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #1e3a8a;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 6px;
  }

  :global(.project-cell) {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  :global(.project-name) {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--ink);
  }

  :global(.project-link) {
    color: inherit;
    border-radius: 4px;
    padding: 2px 4px;
    margin-left: -4px;
    transition: background 150ms ease;
  }

  :global(.project-link:hover) {
    background: rgba(255, 255, 255, 0.5);
  }

  :global(.github-link) {
    color: #6b7d96;
    transition: color 150ms ease;
    display: flex;
    align-items: center;
  }

  :global(.github-link:hover) {
    color: var(--accent);
  }

  :global(.description-cell) {
    color: #475569;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  @media (max-width: 900px) {
    .nano-shell {
      grid-template-columns: 1fr;
      padding-top: 40px;
    }

    .side-rail {
      order: 2;
    }

    .toc-card,
    .toc-card + .toc-card {
      position: static;
    }

    .toc-list {
      max-height: none;
    }

    .stack-layers {
      max-width: 100%;
    }

    .stack-layer {
      grid-template-columns: 24px 1fr;
      padding: 14px 16px;
    }

    .layer-index {
      width: 24px;
      height: 24px;
      font-size: 0.75rem;
    }

    .layer-name {
      font-size: 1rem;
    }

    .layer-description {
      font-size: 0.85rem;
    }

    .stack-note {
      padding: 16px;
    }

    .stack-note p {
      font-size: 0.88rem;
    }
  }
</style>
