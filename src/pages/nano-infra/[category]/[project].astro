---
import Layout from '../../../layouts/Layout.astro';
import AutoToc from '../../../components/AutoToc.astro';
import { getCollection } from 'astro:content';
import { slugifySegment } from '../../../utils/slug';
import { marked } from 'marked';

const categoryWhy: Record<string, string> = {
  Silicon:
    'Silicon determines the raw capability envelope of AGI workloads. If you do not understand compute primitives and memory behavior, every optimization above this layer is constrained.',
  Virt:
    'Virtualization controls utilization, isolation, and portability. AGI infrastructure needs efficient multi-tenant execution and reliable abstractions around hardware.',
  Compiler:
    'Compilers convert model intent into executable kernels. For AGI-scale systems, compiler quality directly impacts latency, throughput, and hardware efficiency.',
  Framework:
    'Frameworks are where researchers and production teams spend most of their time. AGI progress depends on frameworks that expose power without hiding critical system trade-offs.',
  Agent:
    'Agents are increasingly central operators of software systems. AGI infrastructure needs agent tooling that is transparent, controlled, and grounded in real system constraints.',
};

export async function getStaticPaths() {
  const categoryOrder = ['Silicon', 'Virt', 'Compiler', 'Framework', 'Agent'];
  const categories = await getCollection('projects');

  // Build all categories for TOC
  const allCategories = categories.map((entry) => {
    const categorySlug = slugifySegment(entry.data.category);
    const projects = entry.data.projects.map((project) => {
      return {
        name: project.name,
        href: `/nano-infra/${categorySlug}/${slugifySegment(project.name)}`,
      };
    });
    return {
      category: entry.data.category,
      categorySlug,
      projects,
    };
  });

  allCategories.sort((a, b) => {
    return categoryOrder.indexOf(a.category) - categoryOrder.indexOf(b.category);
  });

  const allProjects = categories.flatMap((categoryEntry) => {
    const categorySlug = slugifySegment(categoryEntry.data.category);
    return categoryEntry.data.projects.map((project) => {
      return {
        category: categoryEntry.data.category,
        categorySlug,
        project,
        projectSlug: slugifySegment(project.name),
      };
    });
  });

  return allProjects.map((item) => {
    return {
      params: {
        category: item.categorySlug,
        project: item.projectSlug,
      },
      props: {
        project: item.project,
        category: item.category,
        categorySlug: item.categorySlug,
        allCategories,
        canonicalHref: `/nano-infra/${item.categorySlug}/${item.projectSlug}`,
      },
    };
  });
}

const { project, category, categorySlug, allCategories, canonicalHref } = Astro.props;
const whyLead = categoryWhy[category] ?? 'This project supports core AGI infrastructure capabilities.';
const repoUrl = project.repo ? `https://github.com/lastweek/${project.repo}` : null;
const introHtml = project.intro ? marked.parse(project.intro) : null;
const architectureUrl = project.architecture || null;
---

<Layout title={`${project.name} | Vibe Nano`} description={project.description}>
  <main class="detail-shell reveal">
    <aside class="side-rail">
      <AutoToc rootSelector=".content" itemSelector="[data-toc]" />

      <div class="toc-card">
        <p class="toc-title">Nano Projects</p>
        <nav class="toc-list">
          {allCategories.map((cat) => (
            <div class="toc-category">
              <a href={`/nano-infra/${cat.categorySlug}/`} class="toc-category-label">{cat.category}</a>
              {cat.projects.map((proj) => (
                <a href={proj.href} class={proj.href === canonicalHref ? 'active' : ''}>{proj.name}</a>
              ))}
            </div>
          ))}
        </nav>
      </div>
    </aside>

    <article class="content">
      <a href={`/nano-infra/${categorySlug}/`} class="back-link">← Back to {category}</a>

      {repoUrl ? (
        <a href={repoUrl} target="_blank" rel="noopener noreferrer" class="repo-banner">
          <span class="repo-icon">⬡</span>
          <div class="repo-info">
            <span class="repo-label">Repository</span>
            <span class="repo-name">{project.repo}</span>
          </div>
          <span class="repo-arrow">↗</span>
        </a>
      ) : (
        <div class="tbd-banner">
          <span class="tbd-badge">TBD</span>
          <span class="tbd-text">Repository not yet available</span>
        </div>
      )}

      <p class="eyebrow">{category}</p>
      <h1>{project.name}</h1>
      <p class="summary">{project.description}</p>

      {architectureUrl && (
        <div class="arch-image-container">
          <img src={architectureUrl} alt={`${project.name} Architecture Diagram`} class="arch-image" />
        </div>
      )}

      <section id="why" class="section" data-toc>
        <h2>Why This Is Important for AGI Infrastructure</h2>
        <p>{whyLead}</p>
        <p>
          Specifically for <strong>{project.name}</strong>, this work creates a clearer path from system design decisions
          to measurable AGI workload behavior.
        </p>
      </section>

      <section id="what" class="section" data-toc>
        <h2>What This Is About</h2>
        <p>{project.description}</p>
      </section>

      {project.goals && project.goals.length > 0 && (
        <section id="goals" class="section" data-toc>
          <h2>Current Goals</h2>
          <ul>
            {project.goals.map((goal: string) => (
              <li>{goal}</li>
            ))}
          </ul>
        </section>
      )}

      {introHtml && (
        <section id="overview" class="section" data-toc>
          <h2>Overview</h2>
          <div class="intro-content" set:html={introHtml} />
          {architectureUrl && (
            <div class="arch-image-container">
              <img src={architectureUrl} alt={`${project.name} Architecture Diagram`} class="arch-image" />
            </div>
          )}
        </section>
      )}
    </article>
  </main>
</Layout>

<style>
  .detail-shell {
    max-width: 1200px;
    margin: 0 auto;
    padding: 42px 20px 86px;
    display: grid;
    grid-template-columns: 290px minmax(0, 1fr);
    gap: 22px;
  }

  .side-rail {
    display: flex;
    flex-direction: column;
    gap: 12px;
    position: sticky;
    top: 82px;
    align-self: start;
    max-height: calc(100vh - 104px);
    overflow: auto;
    padding-right: 2px;
  }

  .toc-card {
    position: static;
    background: rgba(255, 255, 255, 0.92);
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 14px;
  }

  .toc-title {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
    margin-bottom: 10px;
    font-weight: 700;
  }

  .toc-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 520px;
    overflow: auto;
  }

  .toc-category {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .toc-category-label {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--ink);
    padding: 0.25rem 0.45rem;
    border-radius: 6px;
    background: #f0f4f8;
    text-decoration: none;
    display: block;
  }

  .toc-category-label:hover {
    background: #e5eef5;
  }

  .toc-list a {
    font-size: 0.82rem;
    color: var(--ink-soft);
    padding: 0.25rem 0.45rem 0.25rem 1rem;
    border-radius: 6px;
    margin-left: 0.25rem;
    text-decoration: none;
    display: block;
  }

  .toc-list a:hover {
    background: #eef4ff;
    color: var(--ink);
  }

  .toc-list a.active {
    background: #dbeafe;
    color: #1d4ed8;
    font-weight: 600;
  }

  .content {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 28px;
  }

  .back-link {
    color: var(--accent);
    font-size: 0.9rem;
    font-weight: 500;
  }

  .repo-banner {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 16px 0;
    padding: 14px 18px;
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    border: 1px solid #3b82f6;
    border-radius: 12px;
    text-decoration: none;
    transition: transform 180ms ease, box-shadow 180ms ease;
  }

  .repo-banner:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(30, 58, 138, 0.25);
  }

  .repo-icon {
    font-size: 1.5rem;
    color: #60a5fa;
  }

  .repo-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
  }

  .repo-label {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #93c5fd;
  }

  .repo-name {
    font-size: 0.95rem;
    font-weight: 600;
    color: white;
  }

  .repo-arrow {
    font-size: 1.2rem;
    color: #93c5fd;
  }

  .tbd-banner {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 16px 0;
    padding: 14px 18px;
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.1));
    border: 1px solid #fbbf24;
    border-radius: 12px;
  }

  .tbd-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem 0.6rem;
    background: #fbbf24;
    color: #78350f;
    border-radius: 999px;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }

  .tbd-text {
    font-size: 0.9rem;
    color: #92400e;
  }

  .arch-image-container {
    margin-top: 16px;
    border: 1px solid var(--line);
    border-radius: 12px;
    overflow: hidden;
    background: white;
  }

  .arch-image {
    width: 100%;
    height: auto;
    display: block;
  }

  .eyebrow {
    margin-top: 12px;
    text-transform: uppercase;
    letter-spacing: 0.09em;
    font-size: 0.72rem;
    color: var(--muted);
  }

  h1 {
    font-family: var(--font-display);
    letter-spacing: -0.02em;
    font-size: clamp(2rem, 5vw, 3rem);
    line-height: 1.08;
    margin-top: 8px;
  }

  .summary {
    margin-top: 12px;
    color: var(--muted);
    font-size: 1rem;
    line-height: 1.75;
    max-width: 68ch;
  }

  .section {
    margin-top: 30px;
  }

  h2 {
    font-family: var(--font-display);
    font-size: 1.45rem;
    letter-spacing: -0.01em;
    margin-bottom: 10px;
  }

  .section p,
  li {
    color: var(--ink-soft);
    line-height: 1.75;
    font-size: 0.98rem;
  }

  ul {
    list-style: none;
    padding: 0;
    margin-top: 10px;
  }

  li {
    position: relative;
    padding: 7px 0 7px 16px;
  }

  li::before {
    content: '•';
    position: absolute;
    left: 0;
    color: var(--accent);
    font-weight: 700;
  }

  .intro-content {
    margin-top: 12px;
  }

  .intro-content .arch-image-container {
    margin-top: 24px;
  }

  .intro-content :global(h2) {
    font-family: var(--font-display);
    font-size: 1.3rem;
    letter-spacing: -0.01em;
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    color: var(--ink);
  }

  .intro-content :global(h3) {
    font-family: var(--font-display);
    font-size: 1.15rem;
    letter-spacing: -0.01em;
    margin-top: 1.25em;
    margin-bottom: 0.4em;
    color: var(--ink);
  }

  .intro-content :global(p) {
    color: var(--ink-soft);
    line-height: 1.75;
    margin-bottom: 1em;
  }

  .intro-content :global(ul) {
    list-style: disc;
    padding-left: 1.5rem;
    margin: 0.75rem 0 1rem;
  }

  .intro-content :global(li) {
    padding: 0.25rem 0;
    color: var(--ink-soft);
  }

  .intro-content :global(code) {
    font-size: 0.9em;
    background: #eaf1ff;
    padding: 0.15rem 0.35rem;
    border-radius: 4px;
    color: #1e40af;
    font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
  }

  .intro-content :global(strong) {
    font-weight: 600;
    color: var(--ink);
  }

  @media (max-width: 980px) {
    .detail-shell {
      grid-template-columns: 1fr;
    }

    .side-rail {
      position: static;
      max-height: none;
      overflow: visible;
      order: 2;
    }

    .toc-list {
      max-height: none;
    }
  }
</style>
