---
import Layout from '../../../layouts/Layout.astro';
import AutoToc from '../../../components/AutoToc.astro';
import { getCollection } from 'astro:content';
import { slugifySegment } from '../../../utils/slug';
import { marked } from 'marked';

const categoryWhy: Record<string, string> = {
  Silicon:
    'Silicon determines the raw capability envelope of AGI workloads. If you do not understand compute primitives and memory behavior, every optimization above this layer is constrained.',
  Virt:
    'Virtualization controls utilization, isolation, and portability. AGI infrastructure needs efficient multi-tenant execution and reliable abstractions around hardware.',
  Compiler:
    'Compilers convert model intent into executable kernels. For AGI-scale systems, compiler quality directly impacts latency, throughput, and hardware efficiency.',
  Framework:
    'Frameworks are where researchers and production teams spend most of their time. AGI progress depends on frameworks that expose power without hiding critical system trade-offs.',
  Agent:
    'Agents are increasingly central operators of software systems. AGI infrastructure needs agent tooling that is transparent, controlled, and grounded in real system constraints.',
};

export async function getStaticPaths() {
  const categoryOrder = ['Silicon', 'Virt', 'Compiler', 'Framework', 'Agent'];
  const categories = await getCollection('projects');

  // Build all categories for TOC
  const allCategories = categories.map((entry) => {
    const categorySlug = slugifySegment(entry.data.category);
    const projects = entry.data.projects.map((project) => {
      return {
        name: project.name,
        href: `/nano-infra/${categorySlug}/${slugifySegment(project.name)}`,
      };
    });
    return {
      category: entry.data.category,
      categorySlug,
      projects,
    };
  });

  allCategories.sort((a, b) => {
    return categoryOrder.indexOf(a.category) - categoryOrder.indexOf(b.category);
  });

  const allProjects = categories.flatMap((categoryEntry) => {
    const categorySlug = slugifySegment(categoryEntry.data.category);
    return categoryEntry.data.projects.map((project) => {
      return {
        category: categoryEntry.data.category,
        categorySlug,
        project,
        projectSlug: slugifySegment(project.name),
      };
    });
  });

  return allProjects.map((item) => {
    return {
      params: {
        category: item.categorySlug,
        project: item.projectSlug,
      },
      props: {
        project: item.project,
        category: item.category,
        categorySlug: item.categorySlug,
        allCategories,
        canonicalHref: `/nano-infra/${item.categorySlug}/${item.projectSlug}`,
      },
    };
  });
}

const { project, category, categorySlug, allCategories, canonicalHref } = Astro.props;
const whyLead = categoryWhy[category] ?? 'This project supports core AGI infrastructure capabilities.';
const repoUrl = project.repo ? `https://github.com/lastweek/${project.repo}` : null;
const introHtml = project.intro ? marked.parse(project.intro) : null;
const architectureUrl = project.architecture || null;
---

<Layout title={`${project.name} | Vibe Nano`} description={project.description}>
  <main class="detail-shell reveal">
    <aside class="side-rail">
      <AutoToc rootSelector=".content" itemSelector="[data-toc]" />

      <div class="toc-card">
        <p class="toc-title">Nano Projects</p>
        <nav class="toc-list">
          {allCategories.map((cat) => (
            <div class="toc-category">
              <a href={`/nano-infra/${cat.categorySlug}/`} class="toc-category-label">{cat.category}</a>
              {cat.projects.map((proj) => (
                <a href={proj.href} class={proj.href === canonicalHref ? 'active' : ''}>{proj.name}</a>
              ))}
            </div>
          ))}
        </nav>
      </div>
    </aside>

    <article class="content">
      <a href={`/nano-infra/${categorySlug}/`} class="back-link">← Back to {category}</a>

      {repoUrl ? (
        <a href={repoUrl} target="_blank" rel="noopener noreferrer" class="repo-banner">
          <span class="repo-icon">⬡</span>
          <div class="repo-info">
            <span class="repo-label">Repository</span>
            <span class="repo-name">{project.repo}</span>
          </div>
          <span class="repo-arrow">↗</span>
        </a>
      ) : (
        <div class="tbd-banner">
          <span class="tbd-badge">TBD</span>
          <span class="tbd-text">Repository not yet available</span>
        </div>
      )}

      <p class="eyebrow">{category}</p>
      <h1>{project.name}</h1>
      <p class="summary">{project.description}</p>

      {architectureUrl && (
        <div class="arch-image-container">
          <img src={architectureUrl} alt={`${project.name} Architecture Diagram`} class="arch-image" />
        </div>
      )}

      <section id="why" class="section" data-toc>
        <h2>Why This Is Important for AGI Infrastructure</h2>
        <p>{whyLead}</p>
        <p>
          Specifically for <strong>{project.name}</strong>, this work creates a clearer path from system design decisions
          to measurable AGI workload behavior.
        </p>
      </section>

      <section id="what" class="section" data-toc>
        <h2>What This Is About</h2>
        <p>{project.description}</p>
      </section>

      {project.goals && project.goals.length > 0 && (
        <section id="goals" class="section" data-toc>
          <h2>Current Goals</h2>
          <ul>
            {project.goals.map((goal: string) => (
              <li>{goal}</li>
            ))}
          </ul>
        </section>
      )}

      {introHtml && (
        <section id="overview" class="section" data-toc>
          <h2>Overview</h2>
          <div class="intro-content" set:html={introHtml} />
          {architectureUrl && (
            <div class="arch-image-container">
              <img src={architectureUrl} alt={`${project.name} Architecture Diagram`} class="arch-image" />
            </div>
          )}
        </section>
      )}
    </article>
  </main>

  {introHtml && (
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
  )}

  {introHtml && (
    <script is:inline>
      window.addEventListener('load', async () => {
        console.log('Page loaded, checking for mermaid...');

        if (!window.mermaid) {
          console.error('Mermaid failed to load');
          return;
        }

        console.log('Mermaid loaded, initializing...');

        // Initialize mermaid
        mermaid.initialize({
          startOnLoad: false,
          theme: 'default',
          securityLevel: 'loose',
          fontFamily: 'SF Mono, Menlo, Monaco, Consolas, monospace',
          fontSize: 14,
          flowchart: {
            useMaxWidth: true,
            htmlLabels: true,
            curve: 'basis'
          }
        });

        // Find all mermaid code blocks in intro content
        const mermaidBlocks = document.querySelectorAll('.intro-content pre > code[class*="language-mermaid"]');

        console.log(`Found ${mermaidBlocks.length} mermaid blocks`);

        if (mermaidBlocks.length === 0) {
          console.log('No mermaid blocks found');
          return;
        }

        const uniqueId = Math.random().toString(36).substr(2, 9);

        for (let index = 0; index < mermaidBlocks.length; index++) {
          const block = mermaidBlocks[index];
          const code = block.textContent;
          const id = `mermaid-${uniqueId}-${index}`;

          console.log(`Rendering mermaid diagram ${index}`);

          // Get the pre element
          const preElement = block.parentElement;

          // Create a container for the rendered diagram
          const diagramContainer = document.createElement('div');
          diagramContainer.className = 'mermaid-container';

          // Replace the pre block with the diagram container
          preElement.replaceWith(diagramContainer);

          // Render the diagram
          try {
            const { svg } = await mermaid.render(id, code);
            diagramContainer.innerHTML = svg;
            console.log(`Successfully rendered mermaid diagram ${index}`);
          } catch (error) {
            console.error('Mermaid rendering error:', error);
            diagramContainer.innerHTML = `<pre class="mermaid-error">Error rendering diagram: ${error.message}</pre>`;
          }
        }
      });
    </script>
  )}
</Layout>

<style>
  .detail-shell {
    max-width: 1200px;
    margin: 0 auto;
    padding: 42px 20px 86px;
    display: grid;
    grid-template-columns: 290px minmax(0, 1fr);
    gap: 22px;
  }

  .side-rail {
    display: flex;
    flex-direction: column;
    gap: 12px;
    position: sticky;
    top: 82px;
    align-self: start;
    max-height: calc(100vh - 104px);
    overflow: auto;
    padding-right: 2px;
  }

  .toc-card {
    position: static;
    background: var(--bg-elevated);
    border: 1px solid var(--line-default);
    border-radius: var(--radius-lg);
    padding: 14px;
  }

  .toc-title {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-tertiary);
    margin-bottom: 12px;
    font-weight: 600;
    font-family: var(--font-mono);
  }

  .toc-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-height: 520px;
    overflow: auto;
  }

  .toc-category {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .toc-category-label {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-primary);
    padding: 0.35rem 0.5rem;
    border-radius: var(--radius-sm);
    background: var(--bg-base);
    text-decoration: none;
    display: block;
    font-family: var(--font-mono);
    border: 1px solid var(--line-subtle);
  }

  .toc-category-label:hover {
    background: var(--bg-elevated);
    border-color: var(--line-default);
  }

  .toc-list a {
    font-size: 0.8rem;
    color: var(--text-secondary);
    padding: 0.35rem 0.5rem 0.35rem 1rem;
    border-radius: var(--radius-sm);
    margin-left: 0.25rem;
    text-decoration: none;
    display: block;
    transition: all 140ms ease;
  }

  .toc-list a:hover {
    background: var(--bg-elevated);
    color: var(--text-primary);
  }

  .toc-list a.active {
    background: rgba(37, 99, 235, 0.1);
    color: var(--accent-primary);
    font-weight: 500;
    border-left: 2px solid var(--accent-primary);
    padding-left: calc(1rem - 2px);
  }

  .content {
    background: var(--bg-elevated);
    border: 1px solid var(--line-default);
    border-radius: var(--radius-lg);
    padding: 28px;
  }

  .back-link {
    color: var(--accent-primary);
    font-size: 0.9rem;
    font-weight: 500;
  }

  .repo-banner {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 16px 0;
    padding: 14px 18px;
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.08) 0%, rgba(37, 99, 235, 0.04) 100%);
    border: 1px solid rgba(37, 99, 235, 0.2);
    border-radius: var(--radius-lg);
    text-decoration: none;
    transition: all 180ms ease;
  }

  .repo-banner:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px var(--glow-primary);
    border-color: rgba(37, 99, 235, 0.3);
  }

  .repo-icon {
    font-size: 1.5rem;
    color: var(--accent-primary);
  }

  .repo-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
  }

  .repo-label {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--accent-primary);
    font-family: var(--font-mono);
    opacity: 0.9;
  }

  .repo-name {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .repo-arrow {
    font-size: 1.2rem;
    color: var(--accent-primary);
    opacity: 0.8;
  }

  .tbd-banner {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 16px 0;
    padding: 14px 18px;
    background: rgba(82, 82, 91, 0.15);
    border: 1px solid var(--line-default);
    border-radius: var(--radius-lg);
  }

  .tbd-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem 0.6rem;
    background: var(--status-tbd);
    color: var(--text-tertiary);
    border-radius: var(--radius-sm);
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }

  .tbd-text {
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  .arch-image-container {
    margin-top: 16px;
    border: 1px solid var(--line-default);
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: var(--bg-base);
  }

  .arch-image {
    width: 100%;
    height: auto;
    display: block;
  }

  .eyebrow {
    margin-top: 12px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-size: 0.7rem;
    color: var(--accent-primary);
    font-weight: 600;
    font-family: var(--font-mono);
  }

  h1 {
    font-family: var(--font-display);
    font-weight: 700;
    letter-spacing: -0.03em;
    font-size: clamp(2rem, 5vw, 3rem);
    line-height: 1.06;
    margin-top: 8px;
    color: var(--text-primary);
  }

  .summary {
    margin-top: 12px;
    color: var(--text-secondary);
    font-size: 1rem;
    line-height: 1.75;
    max-width: 68ch;
  }

  .section {
    margin-top: 30px;
  }

  h2 {
    font-family: var(--font-display);
    font-weight: 600;
    font-size: 1.45rem;
    letter-spacing: -0.02em;
    margin-bottom: 10px;
    color: var(--text-primary);
  }

  .section p,
  li {
    color: var(--text-secondary);
    line-height: 1.75;
    font-size: 0.98rem;
  }

  ul {
    list-style: none;
    padding: 0;
    margin-top: 10px;
  }

  li {
    position: relative;
    padding: 7px 0 7px 16px;
  }

  li::before {
    content: '•';
    position: absolute;
    left: 0;
    color: var(--accent-primary);
    font-weight: 700;
  }

  .intro-content {
    margin-top: 12px;
  }

  .intro-content .arch-image-container {
    margin-top: 24px;
  }

  .intro-content :global(h2) {
    font-family: var(--font-display);
    font-weight: 600;
    font-size: 1.3rem;
    letter-spacing: -0.02em;
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    color: var(--text-primary);
  }

  .intro-content :global(h3) {
    font-family: var(--font-display);
    font-weight: 600;
    font-size: 1.15rem;
    letter-spacing: -0.02em;
    margin-top: 1.25em;
    margin-bottom: 0.4em;
    color: var(--text-primary);
  }

  .intro-content :global(p) {
    color: var(--text-secondary);
    line-height: 1.75;
    margin-bottom: 1em;
  }

  .intro-content :global(ul) {
    list-style: disc;
    padding-left: 1.5rem;
    margin: 0.75rem 0 1rem;
  }

  .intro-content :global(li) {
    padding: 0.25rem 0;
    color: var(--text-secondary);
  }

  .intro-content :global(code) {
    font-size: 0.9em;
    background: rgba(37, 99, 235, 0.08);
    padding: 0.15rem 0.4rem;
    border-radius: var(--radius-sm);
    color: var(--accent-primary);
    font-family: var(--font-mono);
  }

  .intro-content :global(strong) {
    font-weight: 600;
    color: var(--text-primary);
  }

  .mermaid-container {
    margin: 28px 0;
    border: 1px solid var(--line-default);
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: #ffffff;
    padding: 20px;
    text-align: center;
  }

  .mermaid-container :global(svg) {
    max-width: 100%;
    height: auto;
  }

  .mermaid-container :global(.node) {
    font-family: var(--font-mono) !important;
  }

  .mermaid-error {
    padding: 16px;
    background: rgba(255, 107, 0, 0.1);
    color: var(--accent-secondary);
    border: 1px solid rgba(255, 107, 0, 0.3);
    border-radius: var(--radius-md);
    font-size: 0.9rem;
    text-align: left;
  }

  @media (max-width: 980px) {
    .detail-shell {
      grid-template-columns: 1fr;
    }

    .side-rail {
      position: static;
      max-height: none;
      overflow: visible;
      order: 2;
    }

    .toc-list {
      max-height: none;
    }
  }
</style>
