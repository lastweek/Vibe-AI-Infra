---
import Layout from '../../../layouts/Layout.astro';
import AutoToc from '../../../components/AutoToc.astro';
import { getCollection } from 'astro:content';
import { slugifySegment } from '../../../utils/slug';

const categoryWhy: Record<string, string> = {
  Silicon:
    'Silicon determines the raw capability envelope of AGI workloads. If you do not understand compute primitives and memory behavior, every optimization above this layer is constrained.',
  Virt:
    'Virtualization controls utilization, isolation, and portability. AGI infrastructure needs efficient multi-tenant execution and reliable abstractions around hardware.',
  Compiler:
    'Compilers convert model intent into executable kernels. For AGI-scale systems, compiler quality directly impacts latency, throughput, and hardware efficiency.',
  Framework:
    'Frameworks are where researchers and production teams spend most of their time. AGI progress depends on frameworks that expose power without hiding critical system trade-offs.',
  Agent:
    'Agents are increasingly central operators of software systems. AGI infrastructure needs agent tooling that is transparent, controlled, and grounded in real system constraints.',
};

export async function getStaticPaths() {
  const categories = await getCollection('projects');
  const allProjects = categories.flatMap((categoryEntry) => {
    const categorySlug = slugifySegment(categoryEntry.data.category);
    return categoryEntry.data.projects.map((project) => ({
      category: categoryEntry.data.category,
      categorySlug,
      project,
      projectSlug: slugifySegment(project.name),
    }));
  });

  const navItems = allProjects.map((item) => ({
    label: item.project.name,
    href: `/nano-infra/${item.categorySlug}/${item.projectSlug}`,
  }));

  return allProjects.map((item) => ({
    params: {
      category: item.categorySlug,
      project: item.projectSlug,
    },
    props: {
      project: item.project,
      category: item.category,
      navItems,
      canonicalHref: `/nano-infra/${item.categorySlug}/${item.projectSlug}`,
    },
  }));
}

const { project, category, navItems, canonicalHref } = Astro.props;
const whyLead = categoryWhy[category] ?? 'This project supports core AGI infrastructure capabilities.';
const statusLabel = project.status === 'WIP' ? 'In Progress' : project.status;
---

<Layout title={`${project.name} | Vibe Nano`} description={project.description}>
  <main class="detail-shell reveal">
    <aside class="side-rail">
      <AutoToc rootSelector=".content" itemSelector="[data-toc]" />

      <div class="toc-card">
        <p class="toc-title">Nano Projects</p>
        <nav class="project-nav">
          {navItems.map((item: { label: string; href: string }) => (
            <a href={item.href} class={item.href === canonicalHref ? 'active' : ''}>
              {item.label}
            </a>
          ))}
        </nav>
      </div>
    </aside>

    <article class="content">
      <a href="/nano-infra" class="back-link">← Back to Vibe Nano</a>
      <p class="eyebrow">{category}</p>
      <h1>{project.name}</h1>
      <p class="summary">{project.description}</p>

      <section id="why" class="section" data-toc>
        <h2>Why This Is Important for AGI Infrastructure</h2>
        <p>{whyLead}</p>
        <p>
          Specifically for <strong>{project.name}</strong>, this work creates a clearer path from system design decisions
          to measurable AGI workload behavior.
        </p>
      </section>

      <section id="what" class="section" data-toc>
        <h2>What This Is About</h2>
        <p>{project.description}</p>
      </section>

      {project.goals && project.goals.length > 0 && (
        <section id="goals" class="section" data-toc>
          <h2>Current Goals</h2>
          <ul>
            {project.goals.map((goal: string) => (
              <li>{goal}</li>
            ))}
          </ul>
        </section>
      )}

      <section id="status" class="section" data-toc>
        <h2>Current Status</h2>
        <p>
          <span class={`status ${project.status}`}>{statusLabel}</span>
        </p>
        {project.repo && (
          <p class="repo-row">
            Repository:
            <a href={`https://github.com/lastweek/${project.repo}`} target="_blank" rel="noopener noreferrer">
              {project.repo} ↗
            </a>
          </p>
        )}
      </section>
    </article>
  </main>
</Layout>

<style>
  .detail-shell {
    max-width: 1200px;
    margin: 0 auto;
    padding: 42px 20px 86px;
    display: grid;
    grid-template-columns: 290px minmax(0, 1fr);
    gap: 22px;
  }

  .side-rail {
    display: flex;
    flex-direction: column;
    gap: 12px;
    position: sticky;
    top: 82px;
    align-self: start;
    max-height: calc(100vh - 104px);
    overflow: auto;
    padding-right: 2px;
  }

  .toc-card {
    position: static;
    background: rgba(255, 255, 255, 0.92);
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 14px;
  }

  .toc-title {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
    margin-bottom: 10px;
    font-weight: 700;
  }

  .toc-list,
  .project-nav {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .project-nav {
    max-height: 300px;
    overflow: auto;
    padding-right: 2px;
  }

  .toc-list a,
  .project-nav a {
    font-size: 0.86rem;
    color: var(--ink-soft);
    padding: 0.3rem 0.45rem;
    border-radius: 8px;
  }

  .toc-list a:hover,
  .project-nav a:hover {
    background: #eef4ff;
    color: var(--ink);
  }

  .project-nav a.active {
    background: #dbeafe;
    color: #1d4ed8;
    font-weight: 600;
  }

  .content {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 28px;
  }

  .back-link {
    color: var(--accent);
    font-size: 0.9rem;
    font-weight: 500;
  }

  .eyebrow {
    margin-top: 12px;
    text-transform: uppercase;
    letter-spacing: 0.09em;
    font-size: 0.72rem;
    color: var(--muted);
  }

  h1 {
    font-family: var(--font-display);
    letter-spacing: -0.02em;
    font-size: clamp(2rem, 5vw, 3rem);
    line-height: 1.08;
    margin-top: 8px;
  }

  .summary {
    margin-top: 12px;
    color: var(--muted);
    font-size: 1rem;
    line-height: 1.75;
    max-width: 68ch;
  }

  .section {
    margin-top: 30px;
  }

  h2 {
    font-family: var(--font-display);
    font-size: 1.45rem;
    letter-spacing: -0.01em;
    margin-bottom: 10px;
  }

  .section p,
  li {
    color: var(--ink-soft);
    line-height: 1.75;
    font-size: 0.98rem;
  }

  ul {
    list-style: none;
    padding: 0;
    margin-top: 10px;
  }

  li {
    position: relative;
    padding: 7px 0 7px 16px;
  }

  li::before {
    content: '•';
    position: absolute;
    left: 0;
    color: var(--accent);
    font-weight: 700;
  }

  .status {
    display: inline-flex;
    border-radius: 999px;
    padding: 0.3rem 0.65rem;
    font-size: 0.78rem;
    font-weight: 700;
  }

  .status.Done {
    background: #dcfce7;
    color: #166534;
  }

  .status.WIP {
    background: #dbeafe;
    color: #1e40af;
  }

  .status.TBD {
    background: #fff4d7;
    color: #8a4b08;
  }

  .repo-row {
    margin-top: 12px;
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .repo-row a {
    color: var(--accent);
    font-weight: 600;
  }

  @media (max-width: 980px) {
    .detail-shell {
      grid-template-columns: 1fr;
    }

    .side-rail {
      position: static;
      max-height: none;
      overflow: visible;
      order: 2;
    }

    .project-nav {
      max-height: none;
      overflow: visible;
    }
  }
</style>
